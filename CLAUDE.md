# CLAUDE.md

このファイルは、このリポジトリで作業する際にClaude Code (claude.ai/code) へのガイダンスを提供します。

## 重要: 言語設定

**このプロジェクトでは必ず日本語で回答してください。**

## プロジェクト概要

このプロジェクトはlocal LLMを使用したゲーム開発の技術検証リポジトリです。

## 技術スタック

### ゲームエンジン
- **Godot 4.5.1** - 2D専用の機能が充実した軽量ゲームエンジン
- 2D物理エンジン、TileMap、Sprite、アニメーション機能を活用

### LLM統合
- **llama.cpp** - クロスプラットフォーム対応のローカルLLM実行環境
- **Godot LLM** ([github.com/Adriankhl/godot-llm](https://github.com/Adriankhl/godot-llm)) - GDExtensionプラグイン
  - GGUF形式のモデルファイルをサポート
  - 全プラットフォーム対応（Windows/Mac/Linux/Android）
  - GPU加速対応（Vulkan/Metal/CPU）

## 開発環境セットアップ手順

### 1. Godot 4のインストール

```bash
# Homebrewでインストール（Mac）
brew install --cask godot

# バージョン確認
godot --version
# 出力例: 4.5.1.stable.official.f62fdbde1
```

### 3. Godot LLMプラグインのセットアップ

#### 方法1: Godot Asset Library（推奨）
1. Godotエディタを開く
2. 上部の「AssetLib」タブをクリック
3. "Godot LLM"を検索
4. ダウンロード＆インストール

#### 方法2: 手動インストール
1. [リリースページ](https://github.com/Adriankhl/godot-llm/releases)からダウンロード
2. 解凍して`addons/godot_llm`フォルダを`godot-project/addons/`に配置
3. GDExtensionが自動的に読み込まれる（Godot 4.2以降）

### 4. GGUFモデルの準備

テスト用に軽量なモデルを推奨：

- **Qwen2.5-0.5B-Instruct** (~300MB) - 最小・最速
- **TinyLlama-1.1B** (~600MB) - バランス型
- **Llama-3.2-1B-Instruct** (~700MB) - Meta公式・高品質

モデルは`godot-project/models/`に配置する。

## ゲームコンセプト

**折り紙パズル - Origami LLM Game**

2Dスーパースクリブルノーツ風のパズルゲーム。プレイヤーがテキストでオブジェクトを記述すると、LLMがそれを解釈してゲーム内に折り紙オブジェクトを生成します。

### コア機能

1. **LLMベースのオブジェクト生成**
   - ユーザーがテキスト入力（例：「dog」「fire」「water」）
   - LLMがJSON Schema形式で構造化されたデータを生成
   - 色（3桁Hex: RGB）、頂点座標配列による自由な形状定義
   - プリセット形状ではなく、LLMが各オブジェクトに応じた独自の形を生成

2. **折り紙アニメーション**
   - スプライト生成時に回転・スケール・透明度アニメーション
   - 折り目が順番に描画される演出
   - Tweenを使用したスムーズな演出

3. **複数オブジェクト管理**
   - 複数のオブジェクトを同時に配置可能
   - ランダムな位置に生成
   - 左クリックで削除（フェードアウトアニメーション付き）
   - マウスホバーでハイライト

4. **物理エンジン統合**
   - RigidBody2Dによる本格的な物理シミュレーション
   - 重力、衝突判定、空気抵抗
   - オブジェクト同士の相互作用
   - 地面との衝突

### 技術的特徴

- **JSON Schema機能**: LLM出力を完全に構造化
- **決定的な出力**: temperature=0.0で再現性を確保
- **動的形状生成**: プリセットではなく頂点座標配列による自由な形状
- **3桁Hex色**: コンパクトな色指定（F00=赤、0AF=青など）
- **リアルタイム生成**: 生成中のJSONをリアルタイム表示

## ゲームの起動方法

```bash
# ゲームを起動
make start

# Godotエディタを開く（任意）
make edit
```

## プロジェクト構造

```
godot-project/
├── game.gd           # メインゲームロジック
├── game.tscn         # メインシーン
├── llm_test.gd       # LLM統合テスト
├── llm_test.tscn     # テストシーン
├── models/           # GGUFモデル格納ディレクトリ
│   └── qwen2-0_5b-instruct-q8_0.gguf
└── addons/
    └── godot_llm/    # Godot LLMプラグイン
```

## LLM設定

現在の設定（`game.gd`）：

```gdscript
llama.model_path = "res://models/Qwen3-1.7B-BF16.gguf"
llama.n_predict = 300      # 生成トークン数（頂点座標生成のため多め）
llama.temperature = 0.0    # 決定的な出力
llama.should_output_prompt = false
llama.should_output_special = false
```

### JSON Schema

```gdscript
{
  "type": "object",
  "properties": {
    "color": {
      "type": "string",
      "pattern": "^[0-9A-Fa-f]{3}$",
      "description": "折り紙の色（3桁Hex: RGB）"
    },
    "vertices": {
      "type": "array",
      "items": {
        "type": "array",
        "items": {"type": "number"},
        "minItems": 2,
        "maxItems": 2
      },
      "minItems": 3,
      "maxItems": 10,
      "description": "折り紙の形状を定義する頂点座標のリスト [[x1,y1], [x2,y2], ...]。座標は-100から100の範囲"
    }
  },
  "required": ["color", "vertices"]
}
```

## LLMによるオブジェクト生成アプローチ

LLMで10x10ピクセルアートを直接生成するのは困難（空間構造の理解が弱い）。以下は実現可能なアプローチ：

### アプローチ1: 構造的記述 → アルゴリズム生成 ★★★★★（最推奨）

LLMに「ドット配列」ではなく「形状の構造」を記述させる。

**JSON例**:
```json
{
  "category": "武器",
  "type": "sword",
  "components": [
    {"type": "blade", "length": 7, "width": 1, "color": "P"},
    {"type": "crossguard", "width": 5, "height": 1, "color": "N"},
    {"type": "handle", "length": 2, "width": 1, "color": "d"}
  ]
}
```

**メリット**:
- ✅ LLMは構造理解が得意
- ✅ 無限のバリエーション可能
- ✅ 破綻しにくい

### アプローチ2: プリミティブ組み合わせ ★★★★

基本図形（rect, circle, line）を組み合わせる指示をLLMに出させる。

**JSON例**:
```json
{
  "category": "武器",
  "primitives": [
    {"shape": "rect", "x": 4, "y": 0, "w": 2, "h": 7, "color": "P"},
    {"shape": "rect", "x": 2, "y": 6, "w": 6, "h": 1, "color": "N"},
    {"shape": "rect", "x": 4, "y": 7, "w": 2, "h": 3, "color": "d"}
  ]
}
```

**メリット**:
- ✅ LLMは座標指定が比較的得意
- ✅ 柔軟性高い
- ⚠️ たまに変な配置になる可能性

### アプローチ3: ASCII Art → ピクセル変換 ★★★★

LLMはASCII Artが得意。

**JSON例**:
```json
{
  "category": "武器",
  "ascii": [
    "   ||   ",
    "   ||   ",
    "  ||||  ",
    " |||||| ",
    "  ||||  ",
    "   ##   ",
    "  ####  "
  ],
  "color_map": {"|": "P", "#": "d", " ": "-"}
}
```

**メリット**:
- ✅ LLMはASCII描画が比較的得意
- ✅ 視覚的に確認しやすい
- ✅ 色マッピングで多色対応

### アプローチ4: カテゴリ → バリエーション ★★★

LLMには「カテゴリ + 属性」だけ決めさせ、形状はプリセット。

**JSON例**:
```json
{
  "base": "sword",
  "variations": {
    "size": "large",
    "blade_type": "curved",
    "material": "iron",
    "color_scheme": "silver_brown"
  }
}
```

**メリット**:
- ✅ 確実に動く
- ✅ LLMの創造性を活かせる
- ⚠️ 形状の自由度は低い

### アプローチ5: Few-shot学習の極大化 ★★

システムプロンプトに大量の例（50〜100個）を埋め込む。

**メリット**:
- ✅ 追加実装不要
- ⚠️ プロンプトが巨大になる
- ⚠️ 推論速度低下

## 次のステップ（将来の拡張）

- オブジェクト同士の相互作用ルール（例：水+火→消火）
- パズル要素の追加（目標達成システム）
- より多様な形状と色のバリエーション
- オブジェクトの属性による物理パラメータの変更
- セーブ/ロード機能

---

## 新ゲームコンセプト案

### 🔮 **呪文だけで全てを賄うアクションRPG**

武器も装備も一切なし。すべての行動（攻撃、防御、移動、回復）を自作の呪文で実行するアクションRPG。

#### コアコンセプト

**「テキスト入力 → LLM解析 → 呪文効果発動」**

プレイヤーがテキストで呪文を自由に作成し、それをゲーム内で使用する。同じ敵でもプレイヤーごとに全く異なる戦い方ができる。

#### 基本システム

##### 1. 呪文作成システム

プレイヤーが自然言語で呪文を記述：

```
例:
- 「火の玉を3発連射」
- 「周囲の敵を凍らせる氷の壁」
- 「自分の体力を回復する聖なる光」
- 「前方に電撃の槍を突き出す」
```

LLMが解析してJSON生成：

```json
{
  "spell_name": "火の玉連射",
  "type": "projectile",
  "element": "fire",
  "projectile_count": 3,
  "power": 25,
  "mana_cost": 15,
  "cooldown": 2.0,
  "range": "medium",
  "special_effect": "burn"
}
```

ゲーム内でリアルタイム発動。

##### 2. スキルタイプ

- **projectile（飛び道具）**: 火の玉、氷の矢、雷撃など
- **melee（近接）**: 炎の剣、氷の槍、雷の拳など
- **area（範囲）**: 爆発、竜巻、地震など
- **buff（強化）**: 攻撃力アップ、速度上昇など
- **passive（常時発動）**: 火のオーラ、氷の鎧、再生能力など

##### 3. レベルアップ＆成長システム

**文字数制限による成長**:

| レベル | 文字数制限 | スキルスロット | パッシブスロット |
|--------|-----------|---------------|----------------|
| Lv1 | 10文字 | 2個 | 0個 |
| Lv5 | 20文字 | 3個 | 1個 |
| Lv10 | 30文字 | 4個 | 2個 |
| Lv15 | 40文字 | 5個 | 2個 |
| Lv20 | 60文字 | 6個 | 3個 |

レベルが上がるほど複雑で強力な呪文を作れる。

例:
- Lv1: 「火の玉」（4文字）
- Lv5: 「巨大な氷の壁を作る」（11文字）
- Lv10: 「敵全てを焼き尽くす炎の渦」（15文字）
- Lv20: 「天から降り注ぐ聖なる光の雨で周囲の敵を一掃し味方を回復する」（32文字）

##### 4. スキルツリーシステム

レベルアップで獲得したポイントをスキルツリーに振り分け：

```
【基本能力】
├─ 文字数+1 (2pt)
├─ 文字数+2 (5pt)
├─ マナ上限+20 (3pt)
├─ 詠唱速度+20% (4pt)
└─ クールダウン-10% (4pt)

【属性解放】
├─ 火属性解放 (3pt)
├─ 氷属性解放 (3pt)
├─ 雷属性解放 (3pt)
├─ 風属性解放 (4pt)
├─ 土属性解放 (4pt)
├─ 聖属性解放 (5pt)
└─ 闇属性解放 (5pt)

【スロット拡張】
├─ スキルスロット+1 (4pt)
├─ パッシブスロット+1 (6pt)
└─ クイックスロット+1 (5pt)

【特殊能力】
├─ 複数属性混合可能 (10pt)
│   └─ 例: 「炎と氷の竜巻」
├─ 召喚系解放 (8pt)
│   └─ 例: 「火の精霊を召喚」
├─ 自己強化系解放 (6pt)
│   └─ 例: 「鋼の肉体」
├─ 範囲効果拡大 (7pt)
└─ 持続効果延長 (6pt)
```

##### 5. 呪文の例

**序盤（Lv1-5）**:
- 「火の玉」→ 基本的な火属性攻撃
- 「回復」→ HP少量回復
- 「盾」→ 一時的に防御力UP

**中盤（Lv6-10）**:
- 「氷の壁を3つ作る」→ 弾幕防御
- 「連続で雷を落とす」→ 範囲攻撃
- 「炎をまとう」→ パッシブ、接触ダメージ

**終盤（Lv11-20）**:
- 「全ての敵を焼き尽くす業火の竜巻」→ 超広範囲攻撃
- 「時を止めて周囲の敵を氷漬けにする」→ CC+ダメージ
- 「不死身の体と無限の魔力を得る」→ 超強化バフ

#### ゲームプレイループ

1. **ダンジョン探索**（トップダウン2D）
2. **敵と遭遇**
3. **自作の呪文で戦闘**
4. **経験値獲得→レベルアップ**
5. **新しい呪文を作成・強化**
6. **より強い敵に挑戦**

#### LLMの役割

##### LLMが担当すること ✅
- 呪文テキストの解析
- パラメータ生成（威力、範囲、コストなど）
- 属性・効果の判定
- バランス調整（自動で適切な値を算出）

##### ゲームエンジン（Godot）が担当すること
- 実際のエフェクト表示（プリセット10-15種類）
- 物理演算・当たり判定
- 敵AIの行動（固定パターン）
- レベルアップ・経験値システム
- UI表示

#### 技術的実装

##### JSON Schema例

```gdscript
var spell_schema = {
  "type": "object",
  "properties": {
    "spell_type": {
      "type": "string",
      "enum": ["projectile", "melee", "area", "buff", "passive", "summon"]
    },
    "element": {
      "type": "string",
      "enum": ["fire", "ice", "lightning", "wind", "earth", "holy", "dark", "physical", "mixed"]
    },
    "power": {"type": "number", "minimum": 1, "maximum": 100},
    "range": {
      "type": "string",
      "enum": ["short", "medium", "long", "self", "global"]
    },
    "mana_cost": {"type": "number", "minimum": 1, "maximum": 100},
    "cooldown": {"type": "number", "minimum": 0.5, "maximum": 30.0},
    "projectile_count": {"type": "number", "minimum": 1, "maximum": 10},
    "duration": {"type": "number", "minimum": 0, "maximum": 60},
    "special_effects": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["burn", "freeze", "stun", "poison", "heal", "shield", "speed_up", "slow"]
      }
    }
  },
  "required": ["spell_type", "element", "power", "mana_cost"]
}
```

##### プリセットエフェクト

- 火: オレンジ色の発射体、爆発エフェクト
- 氷: 水色の結晶、凍結エフェクト
- 雷: 黄色の電撃、スパークエフェクト
- 風: 緑色の渦、風切りエフェクト
- 聖: 白色の光、キラキラエフェクト
- 闇: 紫色の波動、暗黒エフェクト

パラメータ（サイズ、速度、個数）で調整して使い回す。

#### 強み

1. **無限のビルド可能性**
   - プレイヤーごとに全く異なるビルド
   - 同じ敵でも戦い方は無限

2. **成長実感が強い**
   - 文字数増加で表現力向上
   - レベル1とレベル20で全く違うプレイ感

3. **創造性を刺激**
   - 「どんな呪文が強い？」
   - 「組み合わせは？」
   - プレイヤー同士で呪文を共有

4. **リプレイ性が高い**
   - 2周目は全く違うビルドで
   - やり込み要素が豊富

5. **LLMの強みを最大活用**
   - テキスト解析
   - パラメータ推定
   - バランス調整

#### 開発ステップ

##### Phase 1: MVP（3-5日）
- [ ] トップダウン2D移動システム
- [ ] 1種類の敵（スライム）
- [ ] LLMでprojectile系呪文のみ生成
- [ ] 基本的なマナ・クールダウンシステム
- [ ] 1-2種類のエフェクト

##### Phase 2: 拡張（5-7日）
- [ ] 複数の呪文タイプ（melee, area, buff）
- [ ] 5-6種類の属性
- [ ] レベルアップ・経験値システム
- [ ] 文字数制限システム
- [ ] 3-5種類の敵

##### Phase 3: 完成（7-10日）
- [ ] スキルツリーシステム
- [ ] パッシブスキル
- [ ] ダンジョン生成
- [ ] ボス戦
- [ ] セーブ/ロード
- [ ] 10種類以上の敵

#### 参考ゲーム

- **Noita**: 呪文の組み合わせで無限のバリエーション
- **Magicka**: 属性を組み合わせて魔法を作る
- **Scribblenauts**: テキスト入力でオブジェクト生成
- **Spellbreak**: 魔法だけで戦うバトルロイヤル

#### まとめ

このゲームは：
- ✅ ローカルLLMの強みを最大限活用
- ✅ プレイヤーの創造性を刺激
- ✅ 高いリプレイ性と中毒性
- ✅ 段階的に実装可能
- ✅ 技術検証として価値が高い
- ✅ ポートフォリオとして魅力的

「武器も装備もなく、呪文だけで全てを賄う」というコンセプトは、LLMならではのユニークな体験を提供できる。
